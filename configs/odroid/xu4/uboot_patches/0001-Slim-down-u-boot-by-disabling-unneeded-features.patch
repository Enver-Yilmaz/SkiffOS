From 4a16fef30e75c58bc749fc347c3d6a6b8b73ebee Mon Sep 17 00:00:00 2001
From: Christian Stewart <christian@paral.in>
Date: Wed, 31 May 2017 14:58:08 -0700
Subject: [PATCH] Slim down u-boot by disabling unneeded features

---
 cmd/Makefile                        |  1 -
 configs/odroid-xu3_defconfig        | 42 +++++++++++++++++++++++++++++++++----
 drivers/usb/gadget/Makefile         |  3 ---
 include/configs/exynos5-common.h    |  9 +-------
 include/configs/exynos5250-common.h | 10 ---------
 tools/Makefile                      |  2 +-
 6 files changed, 40 insertions(+), 27 deletions(-)

diff --git a/cmd/Makefile b/cmd/Makefile
index f13bb8c..f8aa02a 100644
--- a/cmd/Makefile
+++ b/cmd/Makefile
@@ -144,7 +144,6 @@ obj-$(CONFIG_CMD_FASTBOOT) += fastboot.o
 obj-$(CONFIG_CMD_FS_UUID) += fs_uuid.o
 
 obj-$(CONFIG_CMD_USB_MASS_STORAGE) += usb_mass_storage.o
-obj-$(CONFIG_CMD_THOR_DOWNLOAD) += thordown.o
 obj-$(CONFIG_CMD_XIMG) += ximg.o
 obj-$(CONFIG_YAFFS2) += yaffs2.o
 obj-$(CONFIG_CMD_SPL) += spl.o
diff --git a/configs/odroid-xu3_defconfig b/configs/odroid-xu3_defconfig
index dab4cc1..a042e0c 100644
--- a/configs/odroid-xu3_defconfig
+++ b/configs/odroid-xu3_defconfig
@@ -12,12 +12,8 @@ CONFIG_CONSOLE_MUX=y
 CONFIG_SYS_PROMPT="ODROID-XU3 # "
 # CONFIG_CMD_IMLS is not set
 CONFIG_CMD_MMC=y
-CONFIG_CMD_I2C=y
-CONFIG_CMD_USB=y
 CONFIG_CMD_DFU=y
-CONFIG_CMD_USB_MASS_STORAGE=y
 CONFIG_CMD_GPIO=y
-# CONFIG_CMD_SETEXPR is not set
 CONFIG_CMD_CACHE=y
 CONFIG_CMD_TIME=y
 CONFIG_CMD_PMIC=y
@@ -47,3 +43,41 @@ CONFIG_G_DNL_VENDOR_NUM=0x04e8
 CONFIG_G_DNL_PRODUCT_NUM=0x6601
 CONFIG_VIDEO_BRIDGE=y
 CONFIG_ERRNO_STR=y
+
+# SKIFF OVERRIDES
+CONFIG_BOOTDELAY=0
+# CONFIG_DISTRO_DEFAULTS is not set
+CONFIG_CMD_BOOTZ=y
+CONFIG_CMD_BOOTI=y
+CONFIG_CMD_EXT4=y
+CONFIG_CMD_FAT=y
+CONFIG_CMD_USB=y
+CONFIG_CMD_FS_GENERIC=y
+CONFIG_CMD_PART=y
+CONFIG_HUSH_PARSER=y
+# CONFIG_CMD_NET is not set
+# CONFIG_NET is not set
+# CONFIG_CMD_BOOTEFI is not set
+# CONFIG_CMD_BOOTELF is not set
+# CONFIG_CMD_EXPORTENV is not set
+# CONFIG_CMD_SAVEENV is not set
+# CONFIG_CMD_LOADB is not set
+# CONFIG_CMD_LOADS is not set
+# CONFIG_CMD_I2C is not set
+# CONFIG_CMD_DFU is not set
+# CONFIG_CMD_USB_MASS_STORAGE is not set
+# CONFIG_CMD_FPGA is not set
+# CONFIG_CMD_NFS is not set
+# CONFIG_CMD_EXT4_WRITE is not set
+# CONFIG_CMD_DHCP is not set
+# CONFIG_CMD_PXE is not set
+# CONFIG_CMD_MII is not set
+# CONFIG_CMD_PING is not set
+# CONFIG_CMD_EXT2 is not set
+# CONFIG_ISO_PARTITION is not set
+# CONFIG_EFI_LOADER is not set
+# CONFIG_USB_STORAGE is not set
+# CONFIG_USB_GADGET_DOWNLOAD is not set
+# CONFIG_USB_HOST_ETHER is not set
+# CONFIG_USB_FUNCTION_THOR is not set
+# CONFIG_USB_FUNCTION_DFU is not set
diff --git a/drivers/usb/gadget/Makefile b/drivers/usb/gadget/Makefile
index 0fbbb7c..1b6e7ce 100644
--- a/drivers/usb/gadget/Makefile
+++ b/drivers/usb/gadget/Makefile
@@ -23,10 +23,7 @@ obj-$(CONFIG_USB_GADGET_DWC2_OTG_PHY) += dwc2_udc_otg_phy.o
 obj-$(CONFIG_USB_GADGET_FOTG210) += fotg210.o
 obj-$(CONFIG_CI_UDC)	+= ci_udc.o
 ifndef CONFIG_SPL_BUILD
-obj-$(CONFIG_USB_GADGET_DOWNLOAD) += g_dnl.o
-obj-$(CONFIG_USB_FUNCTION_THOR) += f_thor.o
 obj-$(CONFIG_USB_FUNCTION_DFU) += f_dfu.o
-obj-$(CONFIG_USB_FUNCTION_MASS_STORAGE) += f_mass_storage.o
 obj-$(CONFIG_USB_FUNCTION_FASTBOOT) += f_fastboot.o
 endif
 endif
diff --git a/include/configs/exynos5-common.h b/include/configs/exynos5-common.h
index 12ceb2c..2826de6 100644
--- a/include/configs/exynos5-common.h
+++ b/include/configs/exynos5-common.h
@@ -149,11 +149,6 @@
 #define CONFIG_SYS_USB_EHCI_MAX_ROOT_PORTS	3
 #define CONFIG_SYS_USB_XHCI_MAX_ROOT_PORTS	2
 
-#define CONFIG_USB_HOST_ETHER
-#define CONFIG_USB_ETHER_ASIX
-#define CONFIG_USB_ETHER_SMSC95XX
-#define CONFIG_USB_ETHER_RTL8152
-
 /* USB boot mode */
 #define CONFIG_USB_BOOTING
 #define EXYNOS_COPY_USB_FNPTR_ADDR	0x02020070
@@ -162,9 +157,7 @@
 
 #define BOOT_TARGET_DEVICES(func) \
 	func(MMC, mmc, 1) \
-	func(MMC, mmc, 0) \
-	func(PXE, pxe, na) \
-	func(DHCP, dhcp, na)
+	func(MMC, mmc, 0)
 
 #include <config_distro_bootcmd.h>
 
diff --git a/include/configs/exynos5250-common.h b/include/configs/exynos5250-common.h
index aee9fea..c780134 100644
--- a/include/configs/exynos5250-common.h
+++ b/include/configs/exynos5250-common.h
@@ -25,16 +25,6 @@
 
 #define CONFIG_SYS_INIT_SP_ADDR	CONFIG_IRAM_STACK
 
-/* USB */
-#define CONFIG_USB_EHCI
-#define CONFIG_USB_EHCI_EXYNOS
-
-#define CONFIG_USB_XHCI_EXYNOS
-
-#define CONFIG_USB_HOST_ETHER
-#define CONFIG_USB_ETHER_ASIX
-#define CONFIG_USB_ETHER_ASIX88179
-
 /* DRAM Memory Banks */
 #define CONFIG_NR_DRAM_BANKS	8
 #define SDRAM_BANK_SIZE		(256UL << 20UL)	/* 256 MB */
diff --git a/tools/Makefile b/tools/Makefile
index 1c840d7..5775f3a 100644
--- a/tools/Makefile
+++ b/tools/Makefile
@@ -122,7 +122,7 @@ libfdt:
 tools/_libfdt.so: $(patsubst %.o,%.c,$(LIBFDT_OBJS)) tools/libfdt_wrap.c
 	LDFLAGS="$(HOSTLDFLAGS)" python $(srctree)/lib/libfdt/setup.py \
 		"$(_hostc_flags)" $^
-	mv _libfdt.so $@
+	mv _libfdt.*so $@
 
 tools/libfdt_wrap.c: $(srctree)/lib/libfdt/libfdt.swig
 	swig -python -o $@ $<
-- 
2.10.2

